\hypertarget{rollo__comm_8cpp}{}\section{/home/emeres/.hdd/\+Documents/\+Studia/\+Università degli studi di Genova/\+D\+I\+B\+R\+I\+S/\+Tutti i corsi/86805 -\/ S\+O\+F\+T\+W\+A\+R\+E A\+R\+C\+H\+I\+T\+E\+C\+T\+U\+R\+E\+S F\+O\+R R\+O\+B\+O\+T\+I\+C\+S/\+A\+S01/rollo/src/rollo\+\_\+comm.cpp File Reference}
\label{rollo__comm_8cpp}\index{/home/emeres/.\+hdd/\+Documents/\+Studia/\+Università degli studi di Genova/\+D\+I\+B\+R\+I\+S/\+Tutti i corsi/86805 -\/ S\+O\+F\+T\+W\+A\+R\+E A\+R\+C\+H\+I\+T\+E\+C\+T\+U\+R\+E\+S F\+O\+R R\+O\+B\+O\+T\+I\+C\+S/\+A\+S01/rollo/src/rollo\+\_\+comm.\+cpp@{/home/emeres/.\+hdd/\+Documents/\+Studia/\+Università degli studi di Genova/\+D\+I\+B\+R\+I\+S/\+Tutti i corsi/86805 -\/ S\+O\+F\+T\+W\+A\+R\+E A\+R\+C\+H\+I\+T\+E\+C\+T\+U\+R\+E\+S F\+O\+R R\+O\+B\+O\+T\+I\+C\+S/\+A\+S01/rollo/src/rollo\+\_\+comm.\+cpp}}


Communication between R\+O\+S and Rollo.  


{\ttfamily \#include \char`\"{}ros/ros.\+h\char`\"{}}\\*
{\ttfamily \#include $<$sstream$>$}\\*
{\ttfamily \#include $<$iostream$>$}\\*
{\ttfamily \#include \char`\"{}string.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}rollo.\+hpp\char`\"{}}\\*
{\ttfamily \#include \char`\"{}geometry\+\_\+msgs/\+Twist.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}rollo/\+Wheel\+Speed.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}udp.\+h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{rollo__comm_8cpp_ae08ba04eb54f1f3f17f135034452e92c}{decode\+Velocities} (double x, double z, char $\ast$\hyperlink{rollo__comm_8cpp_a6a1049334981cb492eb11e06c60e4fb5}{Message}, int \&Velocity\+L, int \&\hyperlink{rollo__comm_8cpp_aed09ee61ffab38077b4e5852bfcb16e6}{Velocity\+R})
\begin{DoxyCompactList}\small\item\em Range of speed of the Rollo. \end{DoxyCompactList}\item 
void \hyperlink{rollo__comm_8cpp_aed7376fac78c6c864f69338bd09e3133}{subscriber\+Callback} (const geometry\+\_\+msgs\+::\+Twist\+::\+Const\+Ptr \&msg)
\begin{DoxyCompactList}\small\item\em Subscriber callback. \end{DoxyCompactList}\item 
int \hyperlink{rollo__comm_8cpp_a46c0664a525ae3467335e8ba78396d07}{udp\+Send} (char \hyperlink{rollo__comm_8cpp_ac03ec605186c0c6d17c4beaab73d615c}{ip}\mbox{[}16\mbox{]}, int \hyperlink{rollo__comm_8cpp_a63c89c04d1feae07ca35558055155ffb}{port}, char $\ast$\hyperlink{rollo__comm_8cpp_a6a1049334981cb492eb11e06c60e4fb5}{Message})
\begin{DoxyCompactList}\small\item\em Send U\+D\+P packets. \end{DoxyCompactList}\item 
int \hyperlink{rollo__comm_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\begin{DoxyCompactList}\small\item\em Main function. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
char \hyperlink{rollo__comm_8cpp_ac9c755d41ea44e27fdce963bd3ac8d50}{Node\+Name} \mbox{[}20\mbox{]} = C3 C\+M \hyperlink{rollo_8hpp_a876ce77f3c672c7162658151e648389e}{C\+R}
\begin{DoxyCompactList}\small\item\em Global variables updated in the {\ttfamily Subscriber\+Callback} function, processed and used to send commands to the specified {\ttfamily I\+P} adress at the {\ttfamily U\+D\+P} port. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a22cba6fb9ef3df1b681601efb5ccbc2c}{}char \hyperlink{rollo__comm_8cpp_a22cba6fb9ef3df1b681601efb5ccbc2c}{Topic\+Wheel\+Speed} \mbox{[}64\mbox{]} = \hyperlink{rollo_8hpp_ae7e7dd1f59a7dec839d19825d873e077}{T\+O\+P\+I\+C\+\_\+\+C\+O\+M\+M\+\_\+\+W\+S}\label{rollo__comm_8cpp_a22cba6fb9ef3df1b681601efb5ccbc2c}

\begin{DoxyCompactList}\small\item\em Topic for wheel speed containing the actual speed of wheel, preferably extracted from encoders or if not available by using a lookup table. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a88720e7d89de956a13c9cf8eb60aa489}{}char \hyperlink{rollo__comm_8cpp_a88720e7d89de956a13c9cf8eb60aa489}{Topic\+Cmd\+Vel} \mbox{[}64\mbox{]} = T\+O\+P\+I\+C\+\_\+\+C\+T\+R\+L\+\_\+\+C\+M\+D\+\_\+\+V\+E\+L\label{rollo__comm_8cpp_a88720e7d89de956a13c9cf8eb60aa489}

\begin{DoxyCompactList}\small\item\em Topic for commands generated by control node expressed in linear and angular velocity. \end{DoxyCompactList}\item 
char \hyperlink{rollo__comm_8cpp_ac03ec605186c0c6d17c4beaab73d615c}{ip} \mbox{[}16\mbox{]} = \char`\"{}192.\+168.\+0.\+120\char`\"{}
\begin{DoxyCompactList}\small\item\em Rollo default I\+P\+: 192.\+168.\+0.\+120. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a63c89c04d1feae07ca35558055155ffb}{}int \hyperlink{rollo__comm_8cpp_a63c89c04d1feae07ca35558055155ffb}{port} = 900\label{rollo__comm_8cpp_a63c89c04d1feae07ca35558055155ffb}

\begin{DoxyCompactList}\small\item\em U\+D\+P port. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a2687e4b3cb5da7dbd00e565343f66c6c}{}double \hyperlink{rollo__comm_8cpp_a2687e4b3cb5da7dbd00e565343f66c6c}{tol} = 0.\+01\label{rollo__comm_8cpp_a2687e4b3cb5da7dbd00e565343f66c6c}

\begin{DoxyCompactList}\small\item\em Tolerance for determining linear and angular velocities from the control node. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a10a75d5c257fce0d0e521a8f59360759}{}int {\bfseries v\+\_\+l}\label{rollo__comm_8cpp_a10a75d5c257fce0d0e521a8f59360759}

\item 
\hypertarget{rollo__comm_8cpp_a7fb358b515e22053bb9d08df267302ff}{}int \hyperlink{rollo__comm_8cpp_a7fb358b515e22053bb9d08df267302ff}{v\+\_\+r}\label{rollo__comm_8cpp_a7fb358b515e22053bb9d08df267302ff}

\begin{DoxyCompactList}\small\item\em Velocities for both wheels. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a047da550749cbfda4481133dd1ea99af}{}unsigned const int \hyperlink{rollo__comm_8cpp_a047da550749cbfda4481133dd1ea99af}{nb} = 3\label{rollo__comm_8cpp_a047da550749cbfda4481133dd1ea99af}

\begin{DoxyCompactList}\small\item\em Number of bytes in the message. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a6a1049334981cb492eb11e06c60e4fb5}{}char \hyperlink{rollo__comm_8cpp_a6a1049334981cb492eb11e06c60e4fb5}{Message} \mbox{[}\hyperlink{rollo__comm_8cpp_a047da550749cbfda4481133dd1ea99af}{nb}\mbox{]} = \{0x7b, 0x50, 0x10\}\label{rollo__comm_8cpp_a6a1049334981cb492eb11e06c60e4fb5}

\begin{DoxyCompactList}\small\item\em Message combined, complete stop default. \end{DoxyCompactList}\item 
char \hyperlink{rollo__comm_8cpp_a2327c485b9ca6502676def4a22819b21}{Message\+Emergency\+Stop} \mbox{[}\hyperlink{rollo__comm_8cpp_a047da550749cbfda4481133dd1ea99af}{nb}\mbox{]} = \{0x7b, 0x50, 0x10\}
\begin{DoxyCompactList}\small\item\em Emergency variables. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a1a8165a59cdf3528f3915ad5cbc9b20a}{}double \hyperlink{rollo__comm_8cpp_a1a8165a59cdf3528f3915ad5cbc9b20a}{last\+Message\+Time} = 0\label{rollo__comm_8cpp_a1a8165a59cdf3528f3915ad5cbc9b20a}

\begin{DoxyCompactList}\small\item\em Last message from control node. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a272038ad264893a568c808f13d818b17}{}double \hyperlink{rollo__comm_8cpp_a272038ad264893a568c808f13d818b17}{current\+Time} = 0\label{rollo__comm_8cpp_a272038ad264893a568c808f13d818b17}

\begin{DoxyCompactList}\small\item\em Current time holder. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a0d2d7f968a14b48ce6d224fa5a4582b4}{}double \hyperlink{rollo__comm_8cpp_a0d2d7f968a14b48ce6d224fa5a4582b4}{Emergency\+Time} = 30\label{rollo__comm_8cpp_a0d2d7f968a14b48ce6d224fa5a4582b4}

\begin{DoxyCompactList}\small\item\em Emergency time \mbox{[}s\mbox{]}. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a2063db22c564ad7bb00b262c6413295f}{}char \hyperlink{rollo__comm_8cpp_a2063db22c564ad7bb00b262c6413295f}{Mode} \mbox{[}2\mbox{]}\label{rollo__comm_8cpp_a2063db22c564ad7bb00b262c6413295f}

\begin{DoxyCompactList}\small\item\em Message mode description. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a84e1322ee9513953d58e396cb32b125e}{}int {\bfseries Velocity\+L}\label{rollo__comm_8cpp_a84e1322ee9513953d58e396cb32b125e}

\item 
\hypertarget{rollo__comm_8cpp_aed09ee61ffab38077b4e5852bfcb16e6}{}int \hyperlink{rollo__comm_8cpp_aed09ee61ffab38077b4e5852bfcb16e6}{Velocity\+R}\label{rollo__comm_8cpp_aed09ee61ffab38077b4e5852bfcb16e6}

\begin{DoxyCompactList}\small\item\em Message velocities description. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_ae1cdd4055b04d9f7ec3e9b5833728768}{}unsigned int \hyperlink{rollo__comm_8cpp_ae1cdd4055b04d9f7ec3e9b5833728768}{loopcounter} = 1\label{rollo__comm_8cpp_ae1cdd4055b04d9f7ec3e9b5833728768}

\begin{DoxyCompactList}\small\item\em Loop counter for debugging purpose. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a4dd7cdb763ac065ea299d60fb7a5112c}{}double \hyperlink{rollo__comm_8cpp_a4dd7cdb763ac065ea299d60fb7a5112c}{Rollo\+Max} = R\+O\+L\+L\+O\+\_\+\+S\+P\+E\+E\+D\+\_\+\+M\+A\+X\label{rollo__comm_8cpp_a4dd7cdb763ac065ea299d60fb7a5112c}

\begin{DoxyCompactList}\small\item\em Maximum speed of the Rollo. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a732f8fd84c939ac35086428409dc65ff}{}double \hyperlink{rollo__comm_8cpp_a732f8fd84c939ac35086428409dc65ff}{Rollo\+Min} = R\+O\+L\+L\+O\+\_\+\+S\+P\+E\+E\+D\+\_\+\+M\+I\+N\label{rollo__comm_8cpp_a732f8fd84c939ac35086428409dc65ff}

\begin{DoxyCompactList}\small\item\em Minimum speed of the Rollo. \end{DoxyCompactList}\item 
\hypertarget{rollo__comm_8cpp_a42b5cf6e37e4d7d69b9e07e460ad50df}{}double {\bfseries Rollo\+Range} = \hyperlink{rollo__comm_8cpp_a4dd7cdb763ac065ea299d60fb7a5112c}{Rollo\+Max} -\/ \hyperlink{rollo__comm_8cpp_a732f8fd84c939ac35086428409dc65ff}{Rollo\+Min}\label{rollo__comm_8cpp_a42b5cf6e37e4d7d69b9e07e460ad50df}

\end{DoxyCompactItemize}


\subsection{Detailed Description}
Communication between R\+O\+S and Rollo. 

\begin{DoxyAuthor}{Author}
Rabbia Asghar, Ernest Skrzypczyk 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
18/2/16 Provides basic communication structure between R\+O\+S holding nodes used for localization and Rollo. Main aspects include\+:
\begin{DoxyItemize}
\item decoding linear and angular velocities provided by control node
\item translate and send message to Rollo
\item publish decoded velocities
\item square test or n-\/th order
\item emergency procedure
\end{DoxyItemize}
\end{DoxyDate}
\begin{DoxySeeAlso}{See also}
\href{https://github.com/em-er-es/rollo/}{\tt https\+://github.\+com/em-\/er-\/es/rollo/} 
\end{DoxySeeAlso}


\subsection{Function Documentation}
\hypertarget{rollo__comm_8cpp_ae08ba04eb54f1f3f17f135034452e92c}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!decode\+Velocities@{decode\+Velocities}}
\index{decode\+Velocities@{decode\+Velocities}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{decode\+Velocities(double x, double z, char $\ast$\+Message, int \&\+Velocity\+L, int \&\+Velocity\+R)}]{\setlength{\rightskip}{0pt plus 5cm}int decode\+Velocities (
\begin{DoxyParamCaption}
\item[{double}]{x, }
\item[{double}]{z, }
\item[{char $\ast$}]{Message, }
\item[{int \&}]{Velocity\+L, }
\item[{int \&}]{Velocity\+R}
\end{DoxyParamCaption}
)}\label{rollo__comm_8cpp_ae08ba04eb54f1f3f17f135034452e92c}


Range of speed of the Rollo. 

Decode linear and angular velocities

Velocities are decoded and stored as partial bytes of the U\+D\+P packet Parameters declared\+: {\ttfamily x}, {\ttfamily z}, {\ttfamily \&Message}, {\ttfamily Velocity\+L}, {\ttfamily Velocity\+R}. \begin{DoxyReturn}{Returns}
0 
\end{DoxyReturn}
Determine corresponding operation mode based on velocities

Complete stop

Right rotation

Left rotation

Lowest speeds for previous modes

Determine speeds based on the position of the \char`\"{}dial\char`\"{} z~\newline
$\vert$-\/a-\/$\vert$-\/ -\/ -\/$\ast$-\/b-\/ -\/ -\/ -\/ -\/$\vert$~\newline
-\/1 z 0 1

Temporary velocity holder

Eliminate problems with dividing through zero by adding a small number to variables

Calculate velocities according to relation expressed in linear and angular velocities ratio

Translate velocities for Rollo Left velocity -\/ Second byte

Right velocity -\/ Third byte

Temporary fix for errartic behaviour of Rollo

Determine forward or backward movement based on linear velocity \hypertarget{rollo__comm_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!main@{main}}
\index{main@{main}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{main(int argc, char $\ast$$\ast$argv)}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$$\ast$}]{argv}
\end{DoxyParamCaption}
)}\label{rollo__comm_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}


Main function. 

Depending on specified parameters processes data from control node and Rollo and transmits them to appropriate targets or runs a square test of n-\/th order

\begin{DoxyReturn}{Returns}
0 
\end{DoxyReturn}
Initialize node

Initialize nodehandle

Initialie subscriber and define topic and message queue size

Publish velocities as \mbox{[}rpm\mbox{]}

Initialize node arguments using command line

Initialize node parameters from launch file or command line. Use a private node handle so that multiple instances of the node can be run simultaneously while using different parameters.

Node main parameters

Square test parameters Default values

Node frequency rate \mbox{[}Hz\mbox{]}

Initialize subscriber message type

Initialize publisher message type

Initialize variables for computing linear and angular velocity of the robot

Client initialization

Square test
\begin{DoxyItemize}
\item Alternatively this square test could be in control node, however communication node is \char`\"{}closer\char`\"{} to Rollo
\end{DoxyItemize}

Print information on current run

Compose turn command

Check square run variable and determine turning direction

For multiple runs the robot would go back and forth providing more reliable data on the actual error In ideal case even a high order square run would result in the robot being at the initial position with initial orientation

Compose forward command

Set initial time

Bytes sent, useful for debugging

Main square loop

Moving forward

Send command 3 times

Wait for the specified time to move forward

Turning

Send command 3 times

Wait for the specified time to turn

Main square loop end

Update run finish time

Print duration time

Update square run counter and check for exit condition

Main loop

Send control command to Rollo

Compose message

Publish message

R\+O\+S spin\+Once

Sleep before running loop again

Increase loopcounter

Main loop end \hypertarget{rollo__comm_8cpp_aed7376fac78c6c864f69338bd09e3133}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!subscriber\+Callback@{subscriber\+Callback}}
\index{subscriber\+Callback@{subscriber\+Callback}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{subscriber\+Callback(const geometry\+\_\+msgs\+::\+Twist\+::\+Const\+Ptr \&msg)}]{\setlength{\rightskip}{0pt plus 5cm}void subscriber\+Callback (
\begin{DoxyParamCaption}
\item[{const geometry\+\_\+msgs\+::\+Twist\+::\+Const\+Ptr \&}]{msg}
\end{DoxyParamCaption}
)}\label{rollo__comm_8cpp_aed7376fac78c6c864f69338bd09e3133}


Subscriber callback. 

Reads newest velocities from control node and translates them into U\+D\+P message Updates latest message time

\begin{DoxyReturn}{Returns}
0 
\end{DoxyReturn}
Update the U\+D\+P message

Update last message time \hypertarget{rollo__comm_8cpp_a46c0664a525ae3467335e8ba78396d07}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!udp\+Send@{udp\+Send}}
\index{udp\+Send@{udp\+Send}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{udp\+Send(char ip[16], int port, char $\ast$\+Message)}]{\setlength{\rightskip}{0pt plus 5cm}int udp\+Send (
\begin{DoxyParamCaption}
\item[{char}]{ip\mbox{[}16\mbox{]}, }
\item[{int}]{port, }
\item[{char $\ast$}]{Message}
\end{DoxyParamCaption}
)}\label{rollo__comm_8cpp_a46c0664a525ae3467335e8ba78396d07}


Send U\+D\+P packets. 

Send provided message using included U\+D\+P library command {\ttfamily \hyperlink{classudp__client__server_1_1udp__client_ac296d1fb6a6006bec5f8f14a81367d0a}{udp\+\_\+client\+\_\+server\+::udp\+\_\+client.\+send()}} 

Parameters declared by reference\+: {\ttfamily \&ip}, {\ttfamily \&port}, {\ttfamily \&message}.

\begin{DoxyReturn}{Returns}
{\ttfamily bs} Bytes sent 
\end{DoxyReturn}
Client initialization

Send U\+D\+P message

Check if number of bytes sent is equal to bytes of composed message

Error handling

Return bytes sent or error code 

\subsection{Variable Documentation}
\hypertarget{rollo__comm_8cpp_ac03ec605186c0c6d17c4beaab73d615c}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!ip@{ip}}
\index{ip@{ip}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{ip}]{\setlength{\rightskip}{0pt plus 5cm}char ip\mbox{[}16\mbox{]} = \char`\"{}192.\+168.\+0.\+120\char`\"{}}\label{rollo__comm_8cpp_ac03ec605186c0c6d17c4beaab73d615c}


Rollo default I\+P\+: 192.\+168.\+0.\+120. 

Ip address statically assigned \hypertarget{rollo__comm_8cpp_a2327c485b9ca6502676def4a22819b21}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!Message\+Emergency\+Stop@{Message\+Emergency\+Stop}}
\index{Message\+Emergency\+Stop@{Message\+Emergency\+Stop}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{Message\+Emergency\+Stop}]{\setlength{\rightskip}{0pt plus 5cm}char Message\+Emergency\+Stop\mbox{[}{\bf nb}\mbox{]} = \{0x7b, 0x50, 0x10\}}\label{rollo__comm_8cpp_a2327c485b9ca6502676def4a22819b21}


Emergency variables. 

Emergency message -\/ complete stop \hypertarget{rollo__comm_8cpp_ac9c755d41ea44e27fdce963bd3ac8d50}{}\index{rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}!Node\+Name@{Node\+Name}}
\index{Node\+Name@{Node\+Name}!rollo\+\_\+comm.\+cpp@{rollo\+\_\+comm.\+cpp}}
\subsubsection[{Node\+Name}]{\setlength{\rightskip}{0pt plus 5cm}char Node\+Name\mbox{[}20\mbox{]} = C3 C\+M {\bf C\+R}}\label{rollo__comm_8cpp_ac9c755d41ea44e27fdce963bd3ac8d50}


Global variables updated in the {\ttfamily Subscriber\+Callback} function, processed and used to send commands to the specified {\ttfamily I\+P} adress at the {\ttfamily U\+D\+P} port. 

Node name using console codes 