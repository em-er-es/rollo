<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Rollo - Localization of a humanoid robot: rollo_ekf.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Rollo - Localization of a humanoid robot
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Project deals with the aspect of localization of a humanoid robot using the extended Kalman filter and ROS as working environment with help of motion capture</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">rollo_ekf.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>EKF implementation for localisation of a robot.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;ros/ros.h&quot;</code><br />
<code>#include &quot;std_msgs/String.h&quot;</code><br />
<code>#include &quot;std_msgs/Header.h&quot;</code><br />
<code>#include &quot;geometry_msgs/Pose.h&quot;</code><br />
<code>#include &quot;geometry_msgs/Pose2D.h&quot;</code><br />
<code>#include &quot;tf/tf.h&quot;</code><br />
<code>#include &quot;rollo/Pose2DStamped.h&quot;</code><br />
<code>#include &quot;rollo/WheelSpeed.h&quot;</code><br />
<code>#include &quot;rollo/EKF.h&quot;</code><br />
<code>#include &lt;sstream&gt;</code><br />
<code>#include &lt;iostream&gt;</code><br />
<code>#include &lt;eigen3/Eigen/Dense&gt;</code><br />
<code>#include &lt;eigen3/Eigen/Cholesky&gt;</code><br />
<code>#include &quot;<a class="el" href="rollo_8hpp_source.html">rollo.hpp</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for rollo_ekf.cpp:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp__incl.svg" width="100%" height="384"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a52396abb9d94db28c626fab5c6fb2d9f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a52396abb9d94db28c626fab5c6fb2d9f">subscriberCallbackMeasurement</a> (const rollo::Pose2DStamped msg)</td></tr>
<tr class="memdesc:a52396abb9d94db28c626fab5c6fb2d9f"><td class="mdescLeft">&#160;</td><td class="mdescRight">SubscriberCallbackMeasurement.  <a href="#a52396abb9d94db28c626fab5c6fb2d9f">More...</a><br /></td></tr>
<tr class="separator:a52396abb9d94db28c626fab5c6fb2d9f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1074d5c031527169ff7e98a7ee5bf4f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#ae1074d5c031527169ff7e98a7ee5bf4f">subscriberCallbackControlInput</a> (const rollo::WheelSpeed msg)</td></tr>
<tr class="separator:ae1074d5c031527169ff7e98a7ee5bf4f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab60fd7d761ccf83f3835431433f04b6"><td class="memItemLeft" align="right" valign="top">rollo::WheelSpeed&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#aab60fd7d761ccf83f3835431433f04b6">interpolateOdometry</a> (rollo::WheelSpeed OdometryPrev, rollo::WheelSpeed OdometryCurrent, double EKFfilterTimeSecs)</td></tr>
<tr class="memdesc:aab60fd7d761ccf83f3835431433f04b6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Linear interpolation of values from odometry.  <a href="#aab60fd7d761ccf83f3835431433f04b6">More...</a><br /></td></tr>
<tr class="separator:aab60fd7d761ccf83f3835431433f04b6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7c91e81d1451df319a3865f1ae1fbe7"><td class="memItemLeft" align="right" valign="top">rollo::Pose2DStamped&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#ab7c91e81d1451df319a3865f1ae1fbe7">interpolateMeasurement</a> (rollo::Pose2DStamped zPrev, rollo::Pose2DStamped zCurrent, double EKFfilterTimeSecs)</td></tr>
<tr class="memdesc:ab7c91e81d1451df319a3865f1ae1fbe7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Linear interpolation of values from measurement (motion capture)  <a href="#ab7c91e81d1451df319a3865f1ae1fbe7">More...</a><br /></td></tr>
<tr class="separator:ab7c91e81d1451df319a3865f1ae1fbe7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0a7fb5aa6464ed1efefad765828d0015"><td class="memItemLeft" align="right" valign="top">Eigen::Vector3d&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a0a7fb5aa6464ed1efefad765828d0015">FSTATE</a> (Eigen::Vector3d x_pp, Eigen::Vector2d u)</td></tr>
<tr class="memdesc:a0a7fb5aa6464ed1efefad765828d0015"><td class="mdescLeft">&#160;</td><td class="mdescRight">Nonlinear state equation function f(x_k-1, u_k-1)  <a href="#a0a7fb5aa6464ed1efefad765828d0015">More...</a><br /></td></tr>
<tr class="separator:a0a7fb5aa6464ed1efefad765828d0015"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acad14776c403d91313295446350809c4"><td class="memItemLeft" align="right" valign="top">Eigen::Matrix3d&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#acad14776c403d91313295446350809c4">JacobianFSTATE</a> (Eigen::Vector3d x_pp, Eigen::Vector2d u)</td></tr>
<tr class="memdesc:acad14776c403d91313295446350809c4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Linearization of f(x_k-1, u_k-1)  <a href="#acad14776c403d91313295446350809c4">More...</a><br /></td></tr>
<tr class="separator:acad14776c403d91313295446350809c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1db8c3c5c87b81f565785543f1ae2048"><td class="memItemLeft" align="right" valign="top">Eigen::Vector3d&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a1db8c3c5c87b81f565785543f1ae2048">HMEAS</a> (Eigen::Vector3d x_cp)</td></tr>
<tr class="memdesc:a1db8c3c5c87b81f565785543f1ae2048"><td class="mdescLeft">&#160;</td><td class="mdescRight">Measurement function h(x_k)  <a href="#a1db8c3c5c87b81f565785543f1ae2048">More...</a><br /></td></tr>
<tr class="separator:a1db8c3c5c87b81f565785543f1ae2048"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c04138a5bfe5d72780bb7e82a18e627"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>
<tr class="memdesc:a3c04138a5bfe5d72780bb7e82a18e627"><td class="mdescLeft">&#160;</td><td class="mdescRight">Node main.  <a href="#a3c04138a5bfe5d72780bb7e82a18e627">More...</a><br /></td></tr>
<tr class="separator:a3c04138a5bfe5d72780bb7e82a18e627"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a09ad376aec92d33ec8b8e24e57a7d145"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a09ad376aec92d33ec8b8e24e57a7d145"></a>
rollo::Pose2DStamped&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a09ad376aec92d33ec8b8e24e57a7d145">zPose2DStamped</a></td></tr>
<tr class="memdesc:a09ad376aec92d33ec8b8e24e57a7d145"><td class="mdescLeft">&#160;</td><td class="mdescRight">Measurement message includes Pose2D along with timestamp. <br /></td></tr>
<tr class="separator:a09ad376aec92d33ec8b8e24e57a7d145"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7353cc288b8b9991c982cd1d6eb00027"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a7353cc288b8b9991c982cd1d6eb00027"></a>
double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a7353cc288b8b9991c982cd1d6eb00027">zTimeSecs</a> = 0</td></tr>
<tr class="memdesc:a7353cc288b8b9991c982cd1d6eb00027"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize variable that save timestamps from both measurement subscriber in double (float64 in message format). <br /></td></tr>
<tr class="separator:a7353cc288b8b9991c982cd1d6eb00027"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f9fc835d4f739424baa6f27358e7915"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a3f9fc835d4f739424baa6f27358e7915"></a>
rollo::WheelSpeed&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a3f9fc835d4f739424baa6f27358e7915">Odometry</a></td></tr>
<tr class="memdesc:a3f9fc835d4f739424baa6f27358e7915"><td class="mdescLeft">&#160;</td><td class="mdescRight">Odometry message includes timestamp and angular velocities for left and right wheel. <br /></td></tr>
<tr class="separator:a3f9fc835d4f739424baa6f27358e7915"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3a8e6902562d4ccb9a61207508b1d64"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af3a8e6902562d4ccb9a61207508b1d64"></a>
double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#af3a8e6902562d4ccb9a61207508b1d64">OdometryTimeSecs</a> = 0</td></tr>
<tr class="memdesc:af3a8e6902562d4ccb9a61207508b1d64"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize variable that save timestamps from odometry subscriber in double (float64 in message format). <br /></td></tr>
<tr class="separator:af3a8e6902562d4ccb9a61207508b1d64"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac9c755d41ea44e27fdce963bd3ac8d50"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ac9c755d41ea44e27fdce963bd3ac8d50"></a>
char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#ac9c755d41ea44e27fdce963bd3ac8d50">NodeName</a> [20] = <a class="el" href="rollo_8hpp.html#acc39015f57b2efb8810b603f188bdf15">C4</a> <a class="el" href="rollo_8hpp.html#a88d70c2c026b9cb514de366a7b20ef8e">KF</a> <a class="el" href="rollo_8hpp.html#a876ce77f3c672c7162658151e648389e">CR</a></td></tr>
<tr class="memdesc:ac9c755d41ea44e27fdce963bd3ac8d50"><td class="mdescLeft">&#160;</td><td class="mdescRight">Node name using console codes. <br /></td></tr>
<tr class="separator:ac9c755d41ea44e27fdce963bd3ac8d50"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a87885b647cee6d9abf5ffe12fdb33add"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a87885b647cee6d9abf5ffe12fdb33add"></a>
char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a87885b647cee6d9abf5ffe12fdb33add">TopicEKF</a> [64] = <a class="el" href="rollo_8hpp.html#ac4a3bd4300adebf4428a73b404d39468">TOPIC_EKF</a></td></tr>
<tr class="memdesc:a87885b647cee6d9abf5ffe12fdb33add"><td class="mdescLeft">&#160;</td><td class="mdescRight">Topic for extended Kalman filter results with all three estimated states and covariance matrix, stamped. <br /></td></tr>
<tr class="separator:a87885b647cee6d9abf5ffe12fdb33add"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22cba6fb9ef3df1b681601efb5ccbc2c"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a22cba6fb9ef3df1b681601efb5ccbc2c"></a>
char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a22cba6fb9ef3df1b681601efb5ccbc2c">TopicWheelSpeed</a> [64] = <a class="el" href="rollo_8hpp.html#ae7e7dd1f59a7dec839d19825d873e077">TOPIC_COMM_WS</a></td></tr>
<tr class="memdesc:a22cba6fb9ef3df1b681601efb5ccbc2c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Topic for wheel speed containing the actual speed of wheel, preferably extracted from encoders or if not available by using a lookup table. <br /></td></tr>
<tr class="separator:a22cba6fb9ef3df1b681601efb5ccbc2c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a85ec1e73270d9a2e4219bbd70a6def15"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a85ec1e73270d9a2e4219bbd70a6def15"></a>
char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rollo__ekf_8cpp.html#a85ec1e73270d9a2e4219bbd70a6def15">TopicPose2DStamped</a> [64] = <a class="el" href="rollo_8hpp.html#a7d2914d9f0103cf7c268f34f1d596a52">TOPIC_PREP_P2DT</a></td></tr>
<tr class="memdesc:a85ec1e73270d9a2e4219bbd70a6def15"><td class="mdescLeft">&#160;</td><td class="mdescRight">Topic for position and orientation stamped from preprocessor node. <br /></td></tr>
<tr class="separator:a85ec1e73270d9a2e4219bbd70a6def15"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>EKF implementation for localisation of a robot. </p>
<dl class="section author"><dt>Author</dt><dd>Rabbia Asghar </dd>
<dd>
Ernest Skrzypczyk</dd></dl>
<dl class="section date"><dt>Date</dt><dd>20/2/16</dd></dl>
<p>Command prototype: <b>rosrun rollo rollo_ekf _rate:=10</b> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">rate</td><td>Sampling frequency of the node &lt;!10 [Hz]&gt;</td></tr>
  </table>
  </dd>
</dl>
<p>Based on control input from communication node in form of control commands and measurement from preprocessor node, extended Kalman filter implementation estimates of states for localization and publishes estimated states with covariance. Additional information in form of odometry based state estimate are also published for easier analysis of the filter results. Kalman filter equations were first implemented in MATLAB, then translated into C++, compared and verified with test values.</p>
<p>Localization of the robot consists of 3 states:</p><ul>
<li>Position (x, y)</li>
<li>Orientation (Theta)</li>
</ul>
<p>For initial state estimate the node uses robots position and orientation taken from Pose2D message from preprocessor node before running EKF iterations. Initial state covariance matrix is taken as an identity matrix.</p>
<p>Timing for EKF update is inspired from Robot Pose EKF (robot/pose/ekf) package available for ROS:<br />
Timings and data at those specific time instants are synchronized in such a manner, that the latest measurements with newer timestamps are interpolated to one and the same timestamp, when all necessary data is available. This allows for a relative comparison of available data, even though an additional error is introduced through interpolating.</p>
<dl class="section see"><dt>See also</dt><dd><a href="http://wiki.ros.org/robot_pose_ekf">http://wiki.ros.org/robot_pose_ekf</a></dd></dl>
<p>Project github repository</p>
<dl class="section see"><dt>See also</dt><dd><a href="https://github.com/em-er-es/rollo/">https://github.com/em-er-es/rollo/</a> </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a0a7fb5aa6464ed1efefad765828d0015"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Eigen::Vector3d FSTATE </td>
          <td>(</td>
          <td class="paramtype">Eigen::Vector3d&#160;</td>
          <td class="paramname"><em>x_pp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Eigen::Vector2d&#160;</td>
          <td class="paramname"><em>u</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Nonlinear state equation function f(x_k-1, u_k-1) </p>
<p>This is part of time update (or prediction update) of EKF. Given a priori state estimate x_k-1|k-1 and u_k-1, it computes predicted value for state x_k|k-1.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">x_pp</td><td>contains a priori state estimate, x_k-1|k-1 </td></tr>
    <tr><td class="paramname">u</td><td>is control input vector, calculated from odometry. It consists of 2 elements, delta S and delta theta</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Eigen::Vector3d, state prediction x_k|k-1 </dd></dl>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_a0a7fb5aa6464ed1efefad765828d0015_icgraph.svg" width="183" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="a1db8c3c5c87b81f565785543f1ae2048"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Eigen::Vector3d HMEAS </td>
          <td>(</td>
          <td class="paramtype">Eigen::Vector3d&#160;</td>
          <td class="paramname"><em>x_cp</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Measurement function h(x_k) </p>
<p>This computes estimated measurement vector based on the latest state estimate.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">x_cp</td><td>contains state prediction x_k|k-1 computed in time update of EKF</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Eigen::Vector3d, contains estimated measurement vector </dd></dl>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_a1db8c3c5c87b81f565785543f1ae2048_icgraph.svg" width="180" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab7c91e81d1451df319a3865f1ae1fbe7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">rollo::Pose2DStamped interpolateMeasurement </td>
          <td>(</td>
          <td class="paramtype">rollo::Pose2DStamped&#160;</td>
          <td class="paramname"><em>zPrev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">rollo::Pose2DStamped&#160;</td>
          <td class="paramname"><em>zCurrent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>EKFfilterTimeSecs</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Linear interpolation of values from measurement (motion capture) </p>
<p>This function performs linear interpolation of robot pose2D for a given time instant. The time for which the robot pose2D are computed is defined by EKFfilterTimeSecs.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">zPrev</td><td>contains robot pose2D and time stamp read at previous instant when EKF was updated. </td></tr>
    <tr><td class="paramname">zCurrent</td><td>contains robot pose2D and time stamp read currently. </td></tr>
    <tr><td class="paramname">EKFfilterTimeSecs</td><td>is the time instant for which the EKF update need to be performed and robot pose2D need to be computed.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>rollo::Pose2DStamped, contains robot pose2D computed for time instant given by EKFfilterTimeSecs using linear interpolation. </dd></dl>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_ab7c91e81d1451df319a3865f1ae1fbe7_icgraph.svg" width="271" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="aab60fd7d761ccf83f3835431433f04b6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">rollo::WheelSpeed interpolateOdometry </td>
          <td>(</td>
          <td class="paramtype">rollo::WheelSpeed&#160;</td>
          <td class="paramname"><em>OdometryPrev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">rollo::WheelSpeed&#160;</td>
          <td class="paramname"><em>OdometryCurrent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>EKFfilterTimeSecs</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Linear interpolation of values from odometry. </p>
<p>This function performs linear interpolation of right and left wheel speed for a given time instant. The time for which the odometry values are computed is defined by <code>EKFfilterTimeSecs</code>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">OdometryPrev</td><td>contains left and right wheel speed and time stamp read at previous instant when EKF was updated. </td></tr>
    <tr><td class="paramname">OdometryCurrent</td><td>contains left and right wheel speed and time stamp read currently. </td></tr>
    <tr><td class="paramname">EKFfilterTimeSecs</td><td>is the time instant for which the EKF update need to be performed and odometry values need to be computed.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>rollo::WheelSpeed, contains left and right wheel speed [rad/s] computed for time instant given by <code>EKFfilterTimeSecs</code> using linear interpolation. </dd></dl>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_aab60fd7d761ccf83f3835431433f04b6_icgraph.svg" width="248" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="acad14776c403d91313295446350809c4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Eigen::Matrix3d JacobianFSTATE </td>
          <td>(</td>
          <td class="paramtype">Eigen::Vector3d&#160;</td>
          <td class="paramname"><em>x_pp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Eigen::Vector2d&#160;</td>
          <td class="paramname"><em>u</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Linearization of f(x_k-1, u_k-1) </p>
<p>This is part of time update(or prediction update) of EKF. This computes Jacobian matrix by taking the partial derivatives of f(x_k-1,u_k-1) with respect to x, evaluated at the last state estimate x_k-1|k-1.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">x_pp</td><td>contains a priori state estimate x_k-1|k-1 </td></tr>
    <tr><td class="paramname">u</td><td>is control input vector, calculated from odometry. It consists of 2 elements, delta S and delta theta</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Eigen::Matrix3d is the Jacobian matrix </dd></dl>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_acad14776c403d91313295446350809c4_icgraph.svg" width="235" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3c04138a5bfe5d72780bb7e82a18e627"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>argv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Node main. </p>
<p>Initialize node, nodehandle, subscribe to messages from preprocessor and communication nodes and publish estimated state of the robot.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">rate</td><td>Sampling frequency of the node &lt;!10 [Hz]&gt;</td></tr>
  </table>
  </dd>
</dl>
<p>Initializes Extended Kalman Filter revelant variables. As a part of initializing, function waits for one message from each subscriber and save timestamps for the first iteration of EKF. State estimate, x_(0|-1) is initialized as the first measurement read from the preprocessor node. Covariance of state estimate, E(0, -1) is initialized as identity matrix.</p>
<p>Run EKF in loop, update estimates. Await new sensor data, determine time step for EKF update and perform necessary interpolation.</p>
<p>Publishes newest estimates of state variables, covariance matrix and timestamp. </p><dl class="section return"><dt>Returns</dt><dd>0 </dd></dl>
<h2>Initialize</h2>
<ul>
<li>Initialize node</li>
<li>Initialize nodehandle for subscribers and publisher</li>
<li>Initialize subscribers:<ul>
<li>Initialize subscriber for measurement data</li>
<li>Initialize subscriber for actual speed of wheels, preferably extracted from encoders or if not available by using a lookup table</li>
</ul>
</li>
<li>Initialize publisher and define topic and message queue size for the publisher</li>
<li>Initialize node arguments using command line</li>
<li>Initialize node parameters from launch file or command line Use a private node handle so that multiple instances of the node can be run simultaneously while using different parameters.</li>
<li>Publishing rate [Hz]</li>
<li>Loop condition and counter variable</li>
<li>Initialize variables involved in computation of EKF:<ul>
<li>Define number of states</li>
<li>Initialize process noise covariance matrix</li>
<li>Initialize measurement noise covariance matrix</li>
<li>Initialize vector for control input u and variables involved in its computation</li>
<li>Initialize state estimate vector a priori</li>
<li>Initialize Jacobian matrix with the partial derivatives of h(x_k) with respect to x, identity for given system</li>
<li>Initialize E_pp: a priori estimated state covariance, E_k-1|k-1 (p refers to k-1)</li>
<li>Initialize variables involved in the prediction update of EKF</li>
<li>Initialize variables involved in the innovation update of EKF</li>
<li>Initialize state estimate vector and state covariance matrix a posteriori</li>
<li>Variables involved in odometry update alone</li>
<li>Variables for determining EKF time step</li>
<li>Variables involved in interpolation of odometry and measurement data</li>
<li>Control input and measurement variables used in EKF update</li>
</ul>
</li>
</ul>
<h2>EKF Initialization loop</h2>
<ul>
<li>Check if data is available from measurement (motion capture)<ul>
<li>Initialize <code>prevzPose2DStamped</code>, <code>prevMeasurementSecs</code> and <code>PreviousEKFfilterTimeSecs</code> </li>
</ul>
</li>
<li>Check if data is available from odometry (control input)<ul>
<li>Initialize <code>prevOdometry</code>, <code>prevOdometrySecs</code> and <code>PreviousEKFfilterTimeSecs</code> </li>
</ul>
</li>
<li>Check if new data has been read from both measurement (motion capture) and odometry (control input)<ul>
<li>Initialize initial state estimate <code>x_pp</code> </li>
</ul>
</li>
</ul>
<h2>Initialization loop end</h2>
<h2>Main loop</h2>
<ul>
<li>Check if new data is available from measurement (motion capture) and odometry (control input)<ul>
<li>If new data is available and measurement data is for timestamp later than odometry's, perform interpolation for measurement</li>
</ul>
</li>
<li>Update timestamp</li>
<li>Interpolate measurements</li>
<li>Update measurement and control input for EKF update</li>
<li>If new data is available and odometry data is for time stamp later than measurement's, perform interpolation for odometry<ul>
<li>Update timestamp</li>
<li>Interpolate odometry</li>
<li>Update measurement and control input for EKF update</li>
</ul>
</li>
<li>Update <code>prevOdometry</code> and <code>prevzPose2DStamped</code> for next loop</li>
</ul>
<h3>EKF update</h3>
<p>Perform EKF update if all sensor data is available:</p>
<ul>
<li>Determine time step for EKF update</li>
<li>Update <code>PreviousEKFfilterTimeSecs</code> for the next loop</li>
<li>Determine control input u from left and right wheel speed for EKF update</li>
<li>Prediction update</li>
<li>Update state prediction based on a priori state estimate and control input</li>
<li>Update predicted state estimate covariance matrix based on a priori state and control input</li>
<li>Innovation update</li>
<li>Estimate measurement based on a priori state estimate</li>
<li>Perform Cholesky decomposition: Instead of standard equations for EKF, use Cholesky factorization for a stable covariance matrix</li>
<li>Compute a posteriori state estimate x_k|k and a posteriori state covariance matrix E_k|k</li>
<li>Update a priori state estimate x_pp and a priori state covariance matrix E_pp for next loop</li>
<li>Determine odometry update without extended Kalman filter</li>
<li>Prepare data for publishing</li>
<li>Pose2D EKF</li>
<li>Covariance</li>
<li>Pose2D odometry</li>
<li>Publish</li>
</ul>
<h3>EKF Update end</h3>
<ul>
<li>Synchronize to rate</li>
</ul>
<h2>Main loop end</h2>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_a3c04138a5bfe5d72780bb7e82a18e627_cgraph.svg" width="322" height="358"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae1074d5c031527169ff7e98a7ee5bf4f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void subscriberCallbackControlInput </td>
          <td>(</td>
          <td class="paramtype">const rollo::WheelSpeed&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Read new message </p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_ae1074d5c031527169ff7e98a7ee5bf4f_icgraph.svg" width="284" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="a52396abb9d94db28c626fab5c6fb2d9f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void subscriberCallbackMeasurement </td>
          <td>(</td>
          <td class="paramtype">const rollo::Pose2DStamped&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>SubscriberCallbackMeasurement. </p>
<p>Subscribe to the topic '/Rollo/preprocessor/pose2dstamped' of the preprocessor node. Read filtered position and orientation of the robot and timestamp. Update global variables <code>zPose2DStamped</code> and <code>zTimeSecs</code> for use in EKF update.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">msg</td><td>- custom defined message (preprocessor node).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NULL </dd></dl>
<p>Read new message </p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="rollo__ekf_8cpp_a52396abb9d94db28c626fab5c6fb2d9f_icgraph.svg" width="322" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
